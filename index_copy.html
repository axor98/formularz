<?php
	if(isset($_GET['akcja']))
		$akcja=$_GET['akcja'];
	else
		$akcja='';

	switch ($akcja) 
	{
		case 'odbierz':
			//echo 'akcja dziala';
			if(isset($_POST['dPOST']))
				$dPHP=$_POST['dPOST'];
			else
				$dPHP='';

			//echo $dPHP;

			$nazwa_pliku="wpisy.txt";
			if(is_writable($nazwa_pliku)&& $dPHP !='' && $plik=fopen($nazwa_pliku,"a+"))
			{
				if(flock($plik,LOCK_EX))
				{
					fwrite($plik,$dPHP."|||");
					flock($plik,LOCK_UN);
					echo 'dzieki za wpisanie sie :P';
				}
				else
				{
					echo 'nie udalo sie wyslac :(';
				}fclose($plik);
			}
			else
				echo 'nie udalo sie sproboj pozniej';
			break;

			case 'pokaz':
				//echo 'Dzieki dziala';
				echo '<h1>Wpisy do ksiegi</h1>';
				$d=explode('|||',file_get_contents('wpisy.txt'));
				$ile=count($d);
				for($i=0;$i<$ile-1;$i++)
				{
					$w=explode('||',$d[$i]);
					echo'<div class="wpisNagl"><span class="wpisNick">'.$w[0].'</span>,<span class="email">'.$w[1].'</span>,<span class="delWpis" alt="Usuń wpis" title"Usuń wpis"></div>';
					echo '<div class="wpisTresc"><p>'.$w[3].'</p></div>';
				}
				echo '<p><a href="">Strona główna</a></p>';
			break;
		default:
			
	
?>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Księga Gości</title>
	<script src="http://code.jquery.com/jquery-latest.js"></script>
		<script>
		$(function(){
			//zapis do pliku
			$('#ksiega').submit(function(){
					var ok = true;
					var kom = '';
					var tresc = $('#tresc').val();
					if(tresc.length > 100)
					{
						ok = false;
						kom += "Za długa treść! ";
					}
						
					var nick = $('input[name="nick"]').val();
					if(nick.length > 20)
						{
						ok = false;
						kom += "Za długi nick! ";
					}
					
					var email = $('input[name="email"]').val();
					var wzorMaila = /^[0-9a-zA-Z_.-]+@[0-9a-zA-Z.-]+\.[a-zA-Z]{2,3}$/;
					if (!wzorMaila.test(email))
						{
						ok = false;
						kom += "Zły adres email! ";
					}
						
					var plec = $('input[name="plec"]:checked').val();
					if(plec != 'k' && plec != 'm')
						{
						ok = false;
						kom += "Złe dane płci! ";
					}

					if(ok)
					{					
						//alert(nick + '-' + email + '-' + plec + '-' + tresc)
						var dJS='dPOST=' + nick + '||' + email + '||' + plec + '||' + tresc;
						$.ajax({
							type     : "POST",
							url      : "?akcja=odbierz",
							data	 : dJS,
							success : function(msg) {
								$('#komunikat').html(msg).fadeIn('normal',function(){
									$('#komunikat').delay(3000).fadeOut();
								});
								$('#ksiega').trigger("reset");
							},
							error:    function(error) {
								$('#komunikat').html(error).fadeIn('normal',function(){
									$('#komunikat').delay(3000).fadeOut();
								});
							}
						});
					}
					else
						$('#komunikat').html('Błedne dane!!!'+kom).fadeIn('normal',function(){
							$('#komunikat').delay(3000).fadeOut();
						});
					return false;
				}); //end submit 
			//odczyt wpisow
				$('#pokaz').click(function(){
					//alert('dzieki dziala');
					$.ajax({
						url 	:"?akcja=pokaz",
						success 	:function(msg){
							$('#ksiega').fadeOut('fast',function(){
								$('#wpisy').html(msg);
							});
						},
						error 	:function(error){
							$('#komunikat').html(error).fadeIn('normal',function(){
								$('#komunikat').delay(3000).fadeOut();
							});
						}
					});//end ajax
				});//end pokaz wpisow
			}); // end jQ
			</script>
<style>
	body{
		background-color: #CC99FF;
	}
	#ksiega{
		margin: 0 auto;
		margin-top: 50px;
		width: 400px;
		height: 400px;
		border-radius: 50%;
	}
	form{
		 position: relative;
		 margin: 0 auto;
		 margin-top: 100px;
		 width: 250px;
	}
</style>
</head>
<body>
		<form id="ksiega">
			<fieldset>
				<legend>Księga gości</legend>
				<p>
					<input type="text" name="nick" required autofocus placeholder="nickname"> Nick
					<br><br><input type="text" name="email" required placeholder="email@em.pl"> E-mail
					<br><br>Płeć<br><input type="radio" name="plec" value="k" checked> Kobieta &nbsp;&nbsp;&nbsp;
					<input type="radio" name="plec" value="m"> Mężczyzna
					<br><br>Treść<br><textarea name="tresc" id="tresc" rows="5" cols="30" placeholder="wpis..."></textarea>
					<br><br><input type="submit" value="Zapisz">
					<button id="pokaz">Pokaż wpisy</button>
				</p>
				<p id="komunikat"></p>
			</fieldset>
		</form>
		<div id="wpisy">
		</div>
	</body>
</html>
<?php
	}
?>

